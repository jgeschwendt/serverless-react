service: serverless-react

frameworkVersion: '>=1.9.0 <2.0.0'

custom:
  stage: ${env:stage, self:provider.stage}
  client:
    bucketName: ${env:APP_DOMAIN_NAME}
    distributionFolder: dist
  webpack:
    includeModules:
      forceInclude:
        - react-dom # required through react-apollo (renderToStringWithData)
    packager: yarn
    webpackConfig: ./config/webpack/webpack.config.server.js

package:
  individually: true

plugins:
  - serverless-finch
  - serverless-webpack # https://github.com/serverless-heaven/serverless-webpack#usage-with-serverless-offline
  - serverless-offline

provider:
  name: aws
  region: us-east-1
  runtime: nodejs6.10
  deploymentBucket: ${env:ARTIFACTS_BUCKET}
  environment:
    API_DOMAIN_NAME: ${env:API_DOMAIN_NAME}
    STAGE: ${self:custom.stage}

functions:
  website:
    name: serverless-react-${self:custom.stage}
    handler: handler.website
    events:
      - http:
          cors: true
          integration: lambda-proxy
          method: get
          path: /
      - http:
          cors: true
          integration: lambda-proxy
          method: get
          path: /{proxy+}

resources:
  Mappings:
    # http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_website_region_endpoints
    RegionMap:
      ap-northeast-1:
        S3HostedZoneId: Z2M4EHUR26P7ZW
        S3WebsiteEndpoint: s3-website-ap-northeast-1.amazonaws.com
      ap-northeast-2:
        S3HostedZoneId: Z3W03O7B5YMIYP
        S3WebsiteEndpoint: s3-website.ap-northeast-2.amazonaws.com
      ap-south-1:
        S3HostedZoneId: Z11RGJOFQNVJUP
        S3WebsiteEndpoint: s3-website.ap-south-1.amazonaws.com
      ap-southeast-1:
        S3HostedZoneId: Z3O0J2DXBE1FTB
        S3WebsiteEndpoint: s3-website-ap-southeast-1.amazonaws.com
      ap-southeast-2:
        S3HostedZoneId: Z1WCIGYICN2BYD
        S3WebsiteEndpoint: s3-website-ap-southeast-2.amazonaws.com
      eu-central-1:
        S3HostedZoneId: Z21DNDUVLTQW6Q
        S3WebsiteEndpoint: s3-website.eu-central-1.amazonaws.com
      eu-west-1:
        S3HostedZoneId: Z1BKCTXD74EZPE
        S3WebsiteEndpoint: s3-website-eu-west-1.amazonaws.com
      sa-east-1:
        S3HostedZoneId: Z7KQH4QJS55SO
        S3WebsiteEndpoint: s3-website-sa-east-1.amazonaws.com
      us-east-1:
        S3HostedZoneId: Z3AQBSTGFYJSTF
        S3WebsiteEndpoint: s3-website-us-east-1.amazonaws.com
      us-east-2:
        S3HostedZoneId: Z2O1EMRO9K5GLX
        S3WebsiteEndpoint: s3-website.us-east-2.amazonaws.com
      us-west-1:
        S3HostedZoneId: Z2F56UZL2M1ACD
        S3WebsiteEndpoint: s3-website-us-west-1.amazonaws.com
      us-west-2:
        S3HostedZoneId: Z3BJ6K6RIION7M
        S3WebsiteEndpoint: s3-website-us-west-2.amazonaws.com

  Resources:
    ApiGatewayBasePathMapping:
      DependsOn: ApiGatewayDomainName
      Type: AWS::ApiGateway::BasePathMapping
      Properties:
        BasePath: ''
        DomainName: ${env:APP_DOMAIN_NAME}
        RestApiId:
          Ref: ApiGatewayRestApi
        Stage: ${self:custom.stage}

    ApiGatewayDomainName:
      Type: AWS::ApiGateway::DomainName
      Properties:
        CertificateArn:	${env:APP_SSL_CERT_ARN}
        DomainName: ${env:APP_DOMAIN_NAME}

    ApiGatewayDNSRecords:
      Type: AWS::Route53::RecordSetGroup
      Properties:
        HostedZoneName: ${env:APP_HOSTED_ZONE}.
        RecordSets:
          - Name: ${env:APP_DOMAIN_NAME}.
            Type: A
            AliasTarget:
              DNSName: {'Fn::GetAtt': ApiGatewayDomainName.DistributionDomainName}
              HostedZoneId: Z2FDTNDATAQYW2
          - Name: ${env:APP_DOMAIN_NAME}.
            Type: AAAA
            AliasTarget:
              DNSName: {'Fn::GetAtt': ApiGatewayDomainName.DistributionDomainName}
              HostedZoneId: Z2FDTNDATAQYW2

    ApiGatewayStaticBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${env:APP_DOMAIN_NAME}

    ApiGatewayResourceStatic:
      Type: AWS::ApiGateway::Resource
      Properties:
        ParentId: {'Fn::GetAtt': [ApiGatewayRestApi, RootResourceId]}
        PathPart: 'static'
        RestApiId: {Ref: ApiGatewayRestApi}

    ApiGatewayResourceStaticProxyVar:
      Type: AWS::ApiGateway::Resource
      Properties:
        ParentId: {Ref: ApiGatewayResourceStatic}
        PathPart: '{proxy+}'
        RestApiId: {Ref: ApiGatewayRestApi}

    ApiGatewayIamRoleExecution:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Statement:
            Effect: Allow
            Principal:
              Service: [apigateway.amazonaws.com]
            Action: [sts:AssumeRole]
        Path: '/'
        Policies:
          - PolicyName: AllowApiGatewayS3Access
            PolicyDocument:
              Statement:
                Effect: Allow
                Resource: {'Fn::Join': ['', ['arn:aws:s3:::', {Ref: ApiGatewayStaticBucket}, '/*']]}
                Action:
                  - s3:Get*
                  - s3:List*

    ApiGatewayMethodStaticProxyVarGet:
      Type: AWS::ApiGateway::Method
      Properties:
        AuthorizationType: NONE
        HttpMethod: GET
        Integration:
          Credentials: {'Fn::Join': ['', ['arn:aws:iam::', {Ref: AWS::AccountId}, ':role/', {Ref: ApiGatewayIamRoleExecution}]]}
          IntegrationHttpMethod: GET
          IntegrationResponses:
            - StatusCode: 200
              ResponseParameters:
                method.response.header.Timestamp: integration.response.header.Date
                method.response.header.Content-Length: integration.response.header.Content-Length
                method.response.header.Content-Type: integration.response.header.Content-Type
            - StatusCode: 400
              SelectionPattern: '400'
              ResponseParameters:
                method.response.header.Content-Length: integration.response.header.Content-Length
                method.response.header.Content-Type: integration.response.header.Content-Type
            - StatusCode: 404
              SelectionPattern: '404'
              ResponseParameters:
                method.response.header.Content-Length: integration.response.header.Content-Length
                method.response.header.Content-Type: integration.response.header.Content-Type
            - StatusCode: 500
              SelectionPattern: '5\d{2}'
              ResponseParameters:
                method.response.header.Content-Length: integration.response.header.Content-Length
                method.response.header.Content-Type: integration.response.header.Content-Type
          PassthroughBehavior: WHEN_NO_MATCH
          RequestParameters:
            integration.request.path.proxy: method.request.path.proxy
          Type: AWS
          Uri: {'Fn::Join': ['', ['arn:aws:apigateway:', {Ref: AWS::Region}, ':s3:path/${env:APP_DOMAIN_NAME}', '/{proxy}']]}
        MethodResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Timestamp: integration.response.header.Date
              method.response.header.Content-Length: integration.response.header.Content-Length
              method.response.header.Content-Type: integration.response.header.Content-Type
          - StatusCode: 400
            ResponseParameters:
              method.response.header.Content-Length: integration.response.header.Content-Length
              method.response.header.Content-Type: integration.response.header.Content-Type
          - StatusCode: 404
            ResponseParameters:
              method.response.header.Content-Length: integration.response.header.Content-Length
              method.response.header.Content-Type: integration.response.header.Content-Type
          - StatusCode: 500
            ResponseParameters:
              method.response.header.Content-Length: integration.response.header.Content-Length
              method.response.header.Content-Type: integration.response.header.Content-Type
        RequestParameters:
          method.request.path.proxy: true
        ResourceId: {Ref: ApiGatewayResourceStaticProxyVar}
        RestApiId: {Ref: ApiGatewayRestApi}
